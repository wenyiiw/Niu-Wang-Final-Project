---
title: "Final project"
author: "Beining Niu"
subtitle: "Due at 11:59pm on Dec 2."
format: pdf
---


```{r}
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(readr)
library(corrplot)

macro_extended <- read_csv("macro_extended.csv")

unemp_raw <- read.csv("unemployment.csv", skip = 1)
tr_unemp <- unemp_raw %>%
  rename(
    date = Month,
    unemployment = unemployment...United.States.
  ) %>%
  mutate(date = ym(date),
         unemployment = as.numeric(unemployment)) %>%
  select(date, unemployment)

# gas price
gas_raw <- read.csv("gas_price.csv", skip = 1)
tr_gas <- gas_raw %>%
  rename(
    date = Month,
    gas = gas.price...United.States.
  ) %>%
  mutate(date = ym(date),
         gas = as.numeric(gas)) %>%
  select(date, gas)

# economic anxiety
anx_raw <- read.csv("economic_anxiety.csv", skip = 1)
tr_anx <- anx_raw %>%
  rename(
    date = Month,
    anxiety = economic.anxiety...United.States.
  ) %>%
  mutate(date = ym(date),
         anxiety = as.numeric(anxiety)) %>%
  select(date, anxiety)

########## 2. Merge into a wide table ##########

tr_all <- tr_unemp %>%
  left_join(tr_gas, by = "date") %>%
  left_join(tr_anx, by = "date")

########## 3. Convert to long format：gt_long.csv ##########

gt_long <- tr_all %>%
  pivot_longer(
    cols      = c(unemployment, gas, anxiety),
    names_to  = "keyword",
    values_to = "trends_index"
  )

write.csv(gt_long, "gt_long.csv", row.names = FALSE)
cat(">>> gt_long.csv has been generated\n")
```



```{r}
merged <- gt_long %>%
  left_join(macro_extended, by = "date") %>%
  arrange(date, keyword)

merged <- merged %>%
  mutate(
    covid_dummy = ifelse(date >= as.Date("2020-03-01"), 1, 0)
  )
```

```{r}
p_unemp <- merged %>%
  filter(keyword == "unemployment") %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = trends_index, color = "GT unemployment"), size = 1) +
  geom_line(aes(y = unrate * 3, color = "Unrate (scaled x3)"), size = 1) +
  labs(title = "Unemployment Search vs Unemployment Rate",
       x = "Date", y = "") +
  scale_color_manual(values = c("GT unemployment" = "tomato",
                                "Unrate (scaled x3)" = "turquoise3")) +
  theme_classic(base_size = 14)

print(p_unemp)
```



```{r}
p_gas <- merged %>%
  filter(keyword == "gas") %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = cpi / 2, color = "CPI (scaled /2)"), size = 1) +
  geom_line(aes(y = trends_index, color = "GT gas"), size = 1) +
  labs(title = "Gas Price Search vs CPI",
       x = "Date", y = "") +
  scale_color_manual(values = c("CPI (scaled /2)" ="turquoise3",
                                "GT gas" = "tomato")) +
  theme_classic(base_size = 14)

print(p_gas)
```


```{r}
p_anxiety <- merged %>%
  filter(keyword == "anxiety") %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = trends_index, color = "GT anxiety"), size = 1) +
  geom_line(aes(y = sentiment, color = "Sentiment"), size = 1) +
  labs(title = "Economic Anxiety Search vs Consumer Sentiment",
       x = "Date", y = "") +
  scale_color_manual(values = c("GT anxiety" = "tomato",
                                "Sentiment" = "turquoise3")) +
  theme_classic(base_size = 14)

print(p_anxiety)
```




```{r}
p_gt_wiki_unemp <- merged %>%
  filter(keyword == "unemployment") %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = scale(trends_index), color = "GT unemployment")) +
  geom_line(aes(y = wiki_unemp_z,        color = "Wikipedia views")) +
  geom_vline(xintercept = as.Date("2020-03-01"),
             linetype = "dashed") +
  labs(title = "Unemployment: Google Searches vs Wikipedia Pageviews",
       x = "Date", y = "Standardized index", color = "") +
  scale_color_manual(values = c("GT unemployment" = "tomato",
                                "Wikipedia views" = "turquoise3")) +
  theme_classic()

print(p_gt_wiki_unemp)
```


```{r}
# Three interaction models (pandemic effect Wiki VIX)

### Unemployment：unrate × covid_dummy ###
d_unemp <- merged %>%
  filter(keyword == "unemployment")

m_unemp_int <- lm(
  trends_index ~ unrate + unrate_lag1 + cpi + sentiment +
    covid_dummy + unrate:covid_dummy +
    wiki_unemp_z + VIX_z,
  data = d_unemp
)

cat("\n===== UNEMPLOYMENT MODEL (Interaction + Wiki + VIX) =====\n")
print(summary(m_unemp_int))


### Gas：cpi × covid_dummy ###
d_gas <- merged %>%
  filter(keyword == "gas")

m_gas_int <- lm(
  trends_index ~ unrate + unrate_lag1 + cpi + sentiment +
    covid_dummy + cpi:covid_dummy +
    wiki_unemp_z + VIX_z,
  data = d_gas
)

cat("\n===== GAS MODEL (Interaction + Wiki + VIX) =====\n")
print(summary(m_gas_int))


### Economic Anxiety：sentiment × covid_dummy ###
d_anx <- merged %>%
  filter(keyword == "anxiety")

m_anx_int <- lm(
  trends_index ~ unrate + unrate_lag1 + cpi + sentiment +
    covid_dummy + sentiment:covid_dummy +
    wiki_unemp_z + VIX_z,
  data = d_anx
)

cat("\n===== ANXIETY MODEL (Interaction + Wiki + VIX) =====\n")
print(summary(m_anx_int))

```



```{r}
# 7. Correlation heatmap（post-COVID, unemployment）
#############################

d_corr <- merged %>%
  filter(keyword == "unemployment",
         date >= as.Date("2020-03-01")) %>%
  select(trends_index, unrate, cpi, sentiment,
         wiki_unemp_z, VIX_z)

cor_mat <- cor(d_corr, use = "complete.obs")

corrplot(cor_mat,
         method = "color",
         addCoef.col = "black",
         tl.col = "black",
         number.cex = 0.7)

```



```{r}
# 7. Correlation heatmap（post-COVID, unemployment）
#############################

d_corr <- merged %>%
  filter(keyword == "unemployment",
         date < as.Date("2020-03-01")) %>%
  select(trends_index, unrate, cpi, sentiment,
         wiki_unemp_z, VIX_z)

cor_mat <- cor(d_corr, use = "complete.obs")

corrplot(cor_mat,
         method = "color",
         addCoef.col = "black",
         tl.col = "black",
         number.cex = 0.7)

```
```




